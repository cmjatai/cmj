import{U as D,z as c,c as T,N as H,w as _,o as R,V as U,f as p,k as s,q as k,j as E,A as z,n as C,i as x,F as J,r as K,J as O,t as L,L as P,W as Q,B as G,C as X,Q as I,R as Y,g as v}from"./vendor-nrg9WaRj.js";import{_ as Z,u as ee,a as se}from"./main-BdV1jcuf.js";import"./vendor_fortawesome-8Bn9qoRt.js";const te={class:"chat-session-view"},ae={class:"chat-header"},oe={key:0,class:"empty-state"},ne={class:"message-bubble"},le=["onClick"],re=["innerHTML"],ie={key:1,class:"message-wrapper model loading"},ce={key:0,class:"chat-input-area"},ue={class:"input-wrapper"},de=["onKeydown","disabled","maxlength"],pe=["disabled"],ve={key:1,class:"chat-input-area permission-denied"},me={__name:"ChatSessionView",props:{wsEndpoint:{type:String,default:"/ws/chat/"}},setup(N){const V=new D({html:!1,linkify:!0,typographer:!0}),W=ee(),g=se(),A=H();Y();const F=X("EventBus"),$=N,r=c([]),i=c(""),n=c(!1),m=c(!1),o=c(null),f=c(null),u=c(null),y=c(250),S=T(()=>A.params.sessionId||"session_"+Math.random().toString(36).substr(2,9)),b=()=>{if(!h.value)return;o.value&&o.value.close();const e=window.location.protocol==="https:"?"wss:":"ws:",t=window.location.host,l=`${e}//${t}${$.wsEndpoint}${S.value}/`;o.value=new WebSocket(l),o.value.onopen=()=>{n.value=!0},o.value.onmessage=a=>{try{const d=JSON.parse(a.data);j(d)}catch(d){console.error("Error parsing WS message:",d)}},o.value.onclose=a=>{n.value=!1,a.code,a.reason,a.code===4001&&g.addMessage({type:"danger",text:"Você abriu esta conversa em outra guia/janela!",timeout:0})},o.value.onerror=a=>{console.error("Chat WebSocket Error:",a),n.value=!1}},j=e=>{switch(e.type){case"connection_established":e.session_id,e.max_length&&(y.value=e.max_length),e.history&&Array.isArray(e.history)&&(r.value=e.history,w());break;case"chat_message":m.value=!1,r.value.length===1&&F.emit("chat:init:conversation"),r.value.push({role:e.role,content:e.message}),w();break;case"error":m.value=!1,r.value.push({role:"system",content:`Erro: ${e.message}`});break;default:console.warn("Unknown message type:",e.type)}},h=T(()=>W.hasPermission("search.can_use_chat_module")),M=()=>{const e=i.value.trim();!e||!n.value||(r.value.push({role:"user",content:e}),i.value="",m.value=!0,w(),o.value.send(JSON.stringify({message:e})),u.value&&(u.value.style.height="auto"))},q=async e=>{try{const t=B(e);if(navigator.clipboard&&navigator.clipboard.write){const l=new Blob([t],{type:"text/html"}),a=new Blob([e],{type:"text/plain"}),d=[new ClipboardItem({"text/html":l,"text/plain":a})];await navigator.clipboard.write(d)}else await navigator.clipboard.writeText(e);g.addMessage({type:"success",text:"Copiado para a área de transferência",timeout:2e3})}catch(t){console.error("Failed to copy:",t);try{await navigator.clipboard.writeText(e),g.addMessage({type:"success",text:"Copiado (apenas texto)",timeout:2e3})}catch{g.addMessage({type:"danger",text:"Erro ao copiar",timeout:2e3})}}},B=e=>V.render(e),w=()=>{I(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})};return _(i,()=>{I(()=>{u.value&&(u.value.style.height="auto",u.value.style.height=u.value.scrollHeight+"px")})}),_(S,()=>{r.value=[],h.value&&b()}),R(()=>{h.value&&b()}),_(h,e=>{e&&!n.value?b():!e&&n.value&&o.value&&o.value.close()}),U(()=>{o.value&&o.value.close()}),(e,t)=>{const l=z("FontAwesomeIcon");return v(),p("div",te,[s("div",ae,[s("h3",null,[k(l,{icon:"hat-wizard"}),t[1]||(t[1]=E(" LegisBee ",-1))]),t[2]||(t[2]=s("h6",null,[E(" Fonte de Dados da LegisBee: "),s("a",{href:"/norma/destaques",target:"_blank",title:"Inicialmente, apenas as normas de destaque estão disponíveis para pesquisa"}," Normas de Destaque ")],-1)),s("span",{class:C(["status-indicator",{connected:n.value}])},null,2)]),s("div",{class:"chat-messages",ref_key:"messagesContainer",ref:f},[r.value.length===0&&h.value?(v(),p("div",oe,[...t[3]||(t[3]=[s("p",null,"Olá! Como posso ajudar você hoje?",-1)])])):x("",!0),(v(!0),p(J,null,K(r.value,(a,d)=>(v(),p("div",{key:d,class:C(["message-wrapper",a.role])},[s("div",ne,[s("button",{class:"copy-btn",onClick:he=>q(a.content),title:"Copiar mensagem"},[k(l,{icon:"copy"})],8,le),s("div",{class:"message-content",innerHTML:B(a.content)},null,8,re)])],2))),128)),m.value?(v(),p("div",ie,[...t[4]||(t[4]=[s("div",{class:"message-bubble"},[s("span",{class:"typing-dot"}),s("span",{class:"typing-dot"}),s("span",{class:"typing-dot"})],-1)])])):x("",!0)],512),h.value?(v(),p("div",ce,[s("div",ue,[s("span",{class:C(["char-counter",{"limit-reached":i.value.length>=y.value}])},L(i.value.length)+" / "+L(y.value),3),O(s("textarea",{"onUpdate:modelValue":t[0]||(t[0]=a=>i.value=a),onKeydown:Q(G(M,["prevent"]),["enter"]),placeholder:"Digite sua mensagem...",disabled:!n.value||m.value,rows:"2",ref_key:"inputRef",ref:u,maxlength:y.value},null,40,de),[[P,i.value]])]),s("button",{onClick:M,disabled:!n.value||!i.value.trim()||m.value,class:"send-btn"},[k(l,{icon:"paper-plane"})],8,pe)])):(v(),p("div",ve,[t[5]||(t[5]=s("p",null,"LegisBee está em desenvolvimento.",-1)),x("",!0)]))])}}},be=Z(me,[["__scopeId","data-v-2f6c25cb"]]);export{be as default};
